# 解压工具技术方案

## 技术选型对比

### Electron vs Tauri

| 维度 | Electron | Tauri |
|------|----------|-------|
| **安装包大小** | ~150MB+ | ~10-20MB |
| **内存占用** | ~200-500MB | ~50-100MB |
| **启动速度** | 较慢 (~2-3s) | 快 (~1s) |
| **开发生态** | 成熟、资源丰富 | 较新、发展快 |
| **前端框架** | 任意 (React/Vue/Svelte) | 任意 |
| **后端语言** | Node.js | Rust |
| **跨平台** | Windows/Mac/Linux | Windows/Mac/Linux |
| **学习曲线** | 较低 | Rust 有门槛 |

### 推荐方案：**Tauri**

#### 选择理由

1. **轻量级** - 解压工具是高频使用的轻量工具，用户期望快速启动
2. **性能** - Rust 后端处理压缩文件更高效
3. **安装包小** - 用户更愿意下载小型工具
4. **安全性** - Rust 内存安全，适合处理文件操作
5. **现代化** - 符合现代桌面应用趋势

#### 权衡考虑
- 如果团队对 Rust 不熟悉，开发周期可能延长
- 可以通过子进程调用现有命令行工具（如 7z、unrar）降低复杂度

---

## 架构设计

### 整体架构

```
┌─────────────────────────────────────────────────────┐
│                    Frontend (UI)                     │
│                  React + TypeScript                  │
├─────────────────────────────────────────────────────┤
│                   Tauri Bridge                       │
│              (IPC 通信层 / Commands)                 │
├─────────────────────────────────────────────────────┤
│                 Backend (Rust Core)                  │
│  ┌─────────────┐ ┌──────────────┐ ┌──────────────┐  │
│  │  Archive    │ │  Preview     │ │   Config     │  │
│  │  Handler    │ │  Service     │ │   Manager    │  │
│  └─────────────┘ └──────────────┘ └──────────────┘  │
│  ┌─────────────────────────────────────────────────┐ │
│  │              Native Libraries                   │ │
│  │   7z • unrar • libarchive • flate2              │ │
│  └─────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

### 模块划分

#### 1. Frontend 层
```
src/
├── components/
│   ├── DropZone.tsx        # 拖拽区域
│   ├── FileList.tsx        # 文件列表预览
│   ├── ProgressBar.tsx     # 解压进度
│   ├── Settings.tsx        # 设置界面
│   └── RecentFiles.tsx     # 最近文件
├── hooks/
│   ├── useArchive.ts       # 压缩包操作
│   └── useSettings.ts      # 设置管理
├── utils/
│   └── formatters.ts       # 格式化工具
└── App.tsx
```

#### 2. Backend 层 (Rust)
```
src-tauri/
├── src/
│   ├── commands/
│   │   ├── mod.rs
│   │   ├── archive.rs      # 解压相关命令
│   │   └── preview.rs      # 预览相关命令
│   ├── services/
│   │   ├── mod.rs
│   │   ├── extractor.rs    # 解压服务
│   │   ├── preview.rs      # 预览服务
│   │   └── security.rs     # 安全检查
│   ├── models/
│   │   └── archive.rs      # 数据模型
│   └── main.rs
└── Cargo.toml
```

---

## 技术实现方案

### 1. 压缩格式支持

#### Rust 库选型

| 格式 | 推荐库 | 备注 |
|------|--------|------|
| ZIP | `zip` crate | 纯 Rust 实现 |
| 7z | `sevenz-rust` 或调用 7z CLI | 7z 格式复杂，CLI 更稳定 |
| tar.gz | `tar` + `flate2` | Rust 标准库组合 |
| tar.bz2 | `tar` + `bzip2` | - |
| RAR | 调用 `unrar` CLI | 授权问题用 CLI 解决 |
| gzip | `flate2` | - |

#### Cargo.toml 依赖
```toml
[dependencies]
tauri = { version = "2", features = ["shell-open", "dialog", "fs"] }
serde = { version = "1", features = ["derive"] }
serde_json = "1"
zip = "0.6"
tar = "0.4"
flate2 = "1"
bzip2 = "0.4"
sevenz-rust = "0.4"  # 或使用 subprocess 调用 7z
walkdir = "2"
```

### 2. 解压服务实现

```rust
// src-tauri/src/services/extractor.rs
pub struct Extractor;

impl Extractor {
    /// 解压文件到指定目录
    pub async fn extract(
        archive_path: &Path,
        target_dir: &Path,
        password: Option<&str>,
    ) -> Result<ExtractResult, ExtractError> {
        // 1. 检测格式
        let format = Self::detect_format(archive_path)?;
        
        // 2. 安全检查
        Self::security_check(archive_path)?;
        
        // 3. 根据格式选择解压器
        match format {
            ArchiveFormat::Zip => Self::extract_zip(archive_path, target_dir, password).await,
            ArchiveFormat::SevenZ => Self::extract_7z(archive_path, target_dir, password).await,
            ArchiveFormat::TarGz => Self::extract_tar_gz(archive_path, target_dir).await,
            ArchiveFormat::Rar => Self::extract_rar(archive_path, target_dir, password).await,
            // ...
        }
    }
    
    /// 安全检查 - 防止 Zip Slip 等攻击
    fn security_check(archive_path: &Path) -> Result<(), ExtractError> {
        // 检查文件是否存在、大小是否合理
        // 扫描压缩包内容，检查是否有恶意路径
        // ...
    }
}
```

### 3. 预览服务实现

```rust
// src-tauri/src/services/preview.rs
pub struct PreviewService;

impl PreviewService {
    /// 获取压缩包文件列表
    pub fn list_contents(archive_path: &Path) -> Result<Vec<ArchiveEntry>, PreviewError> {
        let format = Self::detect_format(archive_path)?;
        
        match format {
            ArchiveFormat::Zip => {
                let file = File::open(archive_path)?;
                let mut archive = ZipArchive::new(file)?;
                
                let mut entries = Vec::new();
                for i in 0..archive.len() {
                    let file = archive.by_index(i)?;
                    entries.push(ArchiveEntry {
                        name: file.name().to_string(),
                        size: file.size(),
                        compressed_size: file.compressed_size(),
                        is_dir: file.is_dir(),
                        modified: file.last_modified().into(),
                    });
                }
                Ok(entries)
            }
            // 其他格式类似...
        }
    }
}
```

### 4. Tauri Commands

```rust
// src-tauri/src/commands/archive.rs
use tauri::command;

#[derive(Serialize)]
pub struct ExtractProgress {
    pub extracted: u64,
    pub total: u64,
    pub current_file: String,
}

#[command]
pub async fn extract_archive(
    path: String,
    target: String,
    password: Option<String>,
    window: Window,
) -> Result<String, String> {
    let path = Path::new(&path);
    let target = Path::new(&target);
    
    // 发送进度事件
    window.emit("extract-progress", ExtractProgress { ... }).ok();
    
    Extractor::extract(path, target, password.as_deref())
        .await
        .map(|r| r.to_string())
        .map_err(|e| e.to_string())
}

#[command]
pub fn preview_archive(path: String) -> Result<Vec<ArchiveEntry>, String> {
    PreviewService::list_contents(Path::new(&path))
        .map_err(|e| e.to_string())
}
```

### 5. 前端调用

```typescript
// src/hooks/useArchive.ts
import { invoke } from '@tauri-apps/api';
import { listen } from '@tauri-apps/api/event';

export function useArchive() {
  const extract = async (path: string, target: string, password?: string) => {
    // 监听进度事件
    const unlisten = await listen('extract-progress', (event) => {
      const progress = event.payload as ExtractProgress;
      setProgress(progress);
    });
    
    try {
      await invoke('extract_archive', { path, target, password });
    } finally {
      unlisten();
    }
  };
  
  const preview = async (path: string) => {
    return await invoke('preview_archive', { path });
  };
  
  return { extract, preview };
}
```

---

## 文件处理策略

### 大文件处理
1. **流式解压** - 避免一次性加载到内存
2. **分块读取** - 控制内存使用
3. **进度回调** - 实时显示进度

### 安全考虑
1. **Zip Slip 防护** - 检查解压路径是否在目标目录内
2. **路径遍历检查** - 禁止 `../` 等危险路径
3. **文件大小限制** - 防止解压炸弹
4. **符号链接处理** - 避免符号链接攻击

```rust
fn validate_entry_path(entry_path: &Path, target_dir: &Path) -> Result<PathBuf, Error> {
    let canonical_target = target_dir.canonicalize()?;
    let canonical_entry = target_dir.join(entry_path).canonicalize()?;
    
    if !canonical_entry.starts_with(&canonical_target) {
        return Err(Error::Security("Path traversal detected"));
    }
    
    Ok(canonical_entry)
}
```

---

## 部署与分发

### 构建配置

```json
// tauri.conf.json
{
  "build": {
    "beforeBuildCommand": "pnpm build",
    "beforeDevCommand": "pnpm dev",
    "devPath": "http://localhost:5173",
    "distDir": "../dist"
  },
  "bundle": {
    "active": true,
    "targets": ["msi", "dmg", "app"],
    "identifier": "com.quickextract.app",
    "icon": ["icons/32x32.png", "icons/128x128.png", "icons/icon.icns"]
  }
}
```

### Windows 分发
- MSI 安装包
- 便携版 (portable.exe)
- 可选：Microsoft Store

### macOS 分发
- DMG 安装包
- 可选：Mac App Store
- 代码签名：需要 Apple Developer 账号

---

## 开发环境配置

### 前置要求
- Node.js 18+
- Rust 1.70+
- pnpm 或 npm

### 初始化项目

```bash
# 创建 Tauri 项目
pnpm create tauri-app quick-extract

# 选择配置
# - Package manager: pnpm
# - UI template: React + TypeScript
# - UI flavor: Tailwind CSS (推荐)

# 安装依赖
cd quick-extract
pnpm install

# 添加 Rust 依赖
cd src-tauri
cargo add zip tar flate2 bzip2 walkdir
```

### 开发命令

```bash
# 启动开发服务器
pnpm tauri dev

# 构建生产版本
pnpm tauri build

# 仅构建前端
pnpm build

# 仅构建后端
cd src-tauri && cargo build --release
```

---

## 性能优化建议

### 启动优化
1. 延迟加载非核心模块
2. 使用 Tauri 的 splashscreen 功能
3. 预加载常用资源

### 解压优化
1. 并行解压多个小文件
2. 使用缓冲区优化 IO
3. 对于大文件使用流式处理

### 内存优化
1. 及时释放资源
2. 使用 Arc<Mutex> 共享数据
3. 避免大对象克隆

---

## 测试策略

### 单元测试
- Rust 核心逻辑测试
- 前端组件测试 (Vitest)

### 集成测试
- 各格式解压测试
- 跨平台兼容性测试

### 端到端测试
- 完整用户流程测试
- 边界情况测试（大文件、加密文件、损坏文件）

---

## 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| Rust 学习曲线 | 开发周期延长 | 可以先用 CLI 工具过渡 |
| RAR 格式授权 | 功能受限 | 使用 unrar CLI |
| 跨平台兼容性 | Bug 增多 | 充分测试，使用 CI/CD |
| 大文件性能 | 用户体验差 | 流式处理，进度显示 |

---

## 里程碑规划

### Week 1: 项目初始化
- [ ] 创建 Tauri 项目
- [ ] 搭建 UI 框架
- [ ] 实现 ZIP 解压

### Week 2: 核心功能
- [ ] 实现 7z、tar.gz 支持
- [ ] 实现预览功能
- [ ] 实现拖拽功能

### Week 3: 打磨发布
- [ ] RAR 支持
- [ ] UI 优化
- [ ] 打包测试
- [ ] 发布 v1.0
